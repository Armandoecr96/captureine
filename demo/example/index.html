<!doctype html>
<html>
  <head>
    <title>Capturine Demo</title>
  </head>
  <body>
    <div>
      <form id='ine-form' name='ine-form'>
        <p>Formulario pre-capcha</p>

        <input id='ine' name='ine' placeholder='Clave de elector' />
        <input id='nu' name='nu' placeholder='Número de emisión' />
        <input id='ocr' name='ocr' placeholder='Número (OCR)' />
        <input id='captcha' name='captcha' placeholder='Escribe la cadena de verificación' />

        <button>Request Capcha</button>
      </form>

      <img id='captcha-source' src="https://media.giphy.com/media/xTk9ZvMnbIiIew7IpW/giphy.gif" alt="" />
    </div>
  </body>
  <script src='https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.1.1/socket.io.js'></script>
  <script>
    ;(function main () {
      const socket = io('http://localhost:3000')

      const form = document.querySelector('#ine-form')
      const captchaSource = document.querySelector('#captcha-source')

      form.addEventListener('submit', handleINEFormSubmit)

      function handleINEFormSubmit (e) {
        e.preventDefault()

        const ine = document.querySelector('#ine').value
        const nu = document.querySelector('#nu').value
        const ocr = document.querySelector('#ocr').value
        const captcha = document.querySelector('#captcha').value

        socket.emit('validateINE', { ine, nu, ocr, captcha }, (isValidINE) => {
          if (isValidINE) return alert('Fue valida')
          return alert('No fue valida')
        })
      }

      socket.emit('getCaptcha', imageCaptcha => {
        const arrayBufferView = new Uint8Array(imageCaptcha)
        const blob = new Blob( [ arrayBufferView ], { type: "image/jpeg" } )
        const urlCreator = window.URL || window.webkitURL
        const imageUrl = urlCreator.createObjectURL(blob)
        captchaSource.src = imageUrl
      })
    })()
  </script>
</html>